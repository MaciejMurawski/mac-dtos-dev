parameters:
  ENVIRONMENT: " "
  SERVICE_CONN: " "
  TF_DIRECTORY: " "
  TF_PLAN_ARTIFACT: " "

steps:
  - task: TerraformTaskV4@4
    name: TerraformPlan
    displayName: Terraform Plan - ${{ parameters.ENVIRONMENT }} Environment
    continueOnError: false
    inputs:
      provider: 'azurerm'
      command: 'plan'
      workingDirectory: ${{ parameters.TF_DIRECTORY }}
      commandOptions: '-input=false -var-file=environments/${{ parameters.ENVIRONMENT }}.tfvars.config -out=$(Build.ArtifactStagingDirectory)/${{ parameters.ENVIRONMENT }}.tfplan'
      environmentServiceNameAzureRM: ${{ parameters.SERVICE_CONNECTION }}

  - task: PublishBuildArtifacts@1
    displayName: "Publish Artifact"
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: ${{ parameters.TF_PLAN_ARTIFACT }}
      publishLocation: 'Container'


  - task: DownloadBuildArtifacts@1
    displayName: Download plan
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: ${{ parameters.TF_PLAN_ARTIFACT }}
      downloadPath: ${{ parameters.TF_DIRECTORY }}

  - task: TerraformTaskV4@4
    continueOnError: false
    displayName: Terraform Apply - ${{ parameters.ENVIRONMENT }}
    inputs:
      provider: 'azurerm'
      command: 'apply'
      workingDirectory: ${{ parameters.TF_DIRECTORY }}
      commandOptions: "${{ parameters.TF_PLAN_ARTIFACT }}/${{ parameters.ENVIRONMENT }}.tfplan"
      environmentServiceNameAzureRM: ${{ parameters.SERVICE_CONNECTION }}
